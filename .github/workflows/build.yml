name: Build Electron App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies (with retry) - Windows PowerShell
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "node version:"; node --version
        Write-Host "npm version:"; npm --version
        $max = 3
        $success = $false
        for ($i = 1; $i -le $max; $i++) {
          Write-Host "Attempt ${i} of ${max}: npm ci --no-audit --no-fund"
          npm ci --no-audit --no-fund
          if ($LASTEXITCODE -eq 0) { $success = $true; break }
          Write-Host "npm ci failed on attempt ${i}"
          if ($i -lt $max) { Start-Sleep -Seconds ($i * 5) }
        }
        if (-not $success) {
          Write-Host "npm ci failed after $max attempts â€” falling back to npm install"
          for ($j = 1; $j -le $max; $j++) {
            Write-Host "Attempt ${j} of ${max}: npm install --no-audit --no-fund"
            npm install --no-audit --no-fund
            if ($LASTEXITCODE -eq 0) { $success = $true; break }
            Write-Host "npm install failed on attempt ${j}"
            if ($j -lt $max) { Start-Sleep -Seconds ($j * 5) }
          }
        }
        if (-not $success) { throw 'All attempts to install dependencies failed' }

    - name: Clean node_modules (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "Cleaning node_modules if present"
        rm -rf node_modules || true

    - name: Clean node_modules (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "Cleaning node_modules on Windows if present"
        if (Test-Path 'node_modules') { Remove-Item -LiteralPath 'node_modules' -Recurse -Force -ErrorAction SilentlyContinue }

    - name: Build (electron-builder)
      run: |
        npm run dist
      env:
        # If you publish, set GH_TOKEN secret; we keep publish disabled
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release and upload assets (tag only)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create GitHub Release with Windows EXE (per-run)
      if: runner.os == 'Windows' && !startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: "Build ${{ github.run_number }}"
        draft: false
        prerelease: true
        files: |
          dist/**/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-dist-${{ matrix.os }}
        path: |
          dist/**

  

# Notes:
# - This workflow runs electron-builder on the hosted runners for each OS.
# - For Windows builds on Linux or cross-platform signing you may need additional tools (wine, osslsigncode).
# - Code signing for macOS/Windows requires secrets and certificates; configure if needed.
# - If you need to include a Python executable, build it per-OS (PyInstaller) and include the binary in extraResources before running electron-builder.
